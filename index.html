<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jojo Poker</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, onSnapshot, doc, setDoc 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ✅ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBiurHUaSI9ytpiTLps9MqY4QHF4MbEt24",
      authDomain: "jojo-pokler.firebaseapp.com",
      projectId: "jojo-pokler",
      storageBucket: "jojo-pokler.firebasestorage.app",
      messagingSenderId: "963260398028",
      appId: "1:963260398028:web:ce28df14ea78042e968569"
    };

    // ✅ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🔹 Elements
    const nameInput = document.getElementById("nameInput");
    const joinBtn = document.getElementById("joinBtn");
    const playersList = document.getElementById("players");
    const startBtn = document.getElementById("startBtn");
    const createSessionBtn = document.getElementById("createSessionBtn");
    const sessionList = document.getElementById("sessionList");
    const gameStatus = document.getElementById("gameStatus");

    // 🔹 Join Lobby
    joinBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      if (!name) return alert("Enter your name!");
      try {
        await addDoc(collection(db, "players"), { name });
        console.log("✅ Player joined:", name);
      } catch(e) {
        console.error("❌ Error joining:", e);
      }
    });

    // 🔹 Live players list
    onSnapshot(collection(db, "players"), snapshot => {
      playersList.innerHTML = "";
      snapshot.forEach(doc => {
        const li = document.createElement("li");
        li.textContent = doc.data().name;
        playersList.appendChild(li);
      });
    });

    // 🔹 Start Game button
    const gameRef = doc(db, "game", "state");
    startBtn.addEventListener("click", async () => {
      try {
        await setDoc(gameRef, { status: "started" });
        console.log("✅ Game started!");
      } catch(e) {
        console.error("❌ Error starting game:", e);
      }
    });

    onSnapshot(gameRef, docSnap => {
      if(docSnap.exists()) {
        const status = docSnap.data().status;
        gameStatus.innerText = `Game Status: ${status}`;
      }
    });

    // 🔹 Create Poker Session
    createSessionBtn.addEventListener("click", async () => {
      try {
        const playersSnapshot = await getDocs(collection(db, "players"));
        const players = [];
        playersSnapshot.forEach(doc => players.push(doc.data().name));
        if(players.length === 0) return alert("No players to start a session!");

        const docRef = await addDoc(collection(db, "sessions"), {
          name: `Session ${new Date().toLocaleTimeString()}`,
          players: players,
          createdAt: new Date(),
          status: "waiting",
          buyIn: 0,
          moneyInHand: 0
        });
        console.log("✅ Session created with ID:", docRef.id);
      } catch(e) {
        console.error("❌ Error creating session:", e);
      }
    });

    // 🔹 Live session list
    onSnapshot(collection(db, "sessions"), snapshot => {
      sessionList.innerHTML = "";
      snapshot.forEach(doc => {
        const s = doc.data();
        const li = document.createElement("li");
        li.textContent = `${s.name} | Players: ${s.players.join(", ")} | Status: ${s.status}`;
        sessionList.appendChild(li);
      });
    });
  </script>
</head>
<body>
  <h1>Jojo Poker Lobby</h1>
  <input id="nameInput" placeholder="Enter your name" />
  <button id="joinBtn">Join Lobby</button>

  <h2>Players in Lobby:</h2>
  <ul id="players"></ul>

  <button id="startBtn">Start Game</button>
  <button id="createSessionBtn">Create Poker Session</button>

  <h2>Active Sessions:</h2>
  <ul id="sessionList"></ul>

  <p id="gameStatus"></p>
</body>
</html>
