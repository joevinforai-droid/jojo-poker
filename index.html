<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jojo Poker</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, onSnapshot, doc, setDoc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBiurHUaSI9ytpiTLps9MqY4QHF4MbEt24",
      authDomain: "jojo-pokler.firebaseapp.com",
      projectId: "jojo-pokler",
      storageBucket: "jojo-pokler.firebasestorage.app",
      messagingSenderId: "963260398028",
      appId: "1:963260398028:web:ce28df14ea78042e968569"
    };

    // ‚úÖ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üîπ Elements
    const nameInput = document.getElementById("nameInput");
    const joinBtn = document.getElementById("joinBtn");
    const playersList = document.getElementById("players");
    const startBtn = document.getElementById("startBtn");
    const createSessionBtn = document.getElementById("createSessionBtn");
    const sessionList = document.getElementById("sessionList");
    const gameStatus = document.getElementById("gameStatus");
    const holeCardsDiv = document.getElementById("holeCardsDiv");
    const card1Input = document.getElementById("card1");
    const card2Input = document.getElementById("card2");
    const submitHoleBtn = document.getElementById("submitHoleBtn");

    const adminDiv = document.getElementById("adminDiv");
    const allHoleCardsList = document.getElementById("allHoleCardsList");
    const flopInput = document.getElementById("flopInput");
    const turnInput = document.getElementById("turnInput");
    const riverInput = document.getElementById("riverInput");
    const submitBoardBtn = document.getElementById("submitBoardBtn");

    let playerName = "";

    // üîπ Join Lobby
    joinBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      if (!name) return alert("Enter your name!");
      playerName = name;

      try {
        await addDoc(collection(db, "players"), { name });
        console.log("‚úÖ Player joined:", name);
        holeCardsDiv.style.display = "block";
      } catch(e) {
        console.error("‚ùå Error joining:", e);
      }
    });

    // üîπ Live players list
    onSnapshot(collection(db, "players"), snapshot => {
      playersList.innerHTML = "";
      snapshot.forEach(doc => {
        const li = document.createElement("li");
        li.textContent = doc.data().name;
        playersList.appendChild(li);
      });
    });

    // üîπ Start Game button
    const gameRef = doc(db, "game", "state");
    startBtn.addEventListener("click", async () => {
      try {
        await setDoc(gameRef, { status: "started" });
        console.log("‚úÖ Game started!");
      } catch(e) {
        console.error("‚ùå Error starting game:", e);
      }
    });

    onSnapshot(gameRef, docSnap => {
      if(docSnap.exists()) {
        const status = docSnap.data().status;
        gameStatus.innerText = `Game Status: ${status}`;
      }
    });

    // üîπ Create Poker Session
    createSessionBtn.addEventListener("click", async () => {
      try {
        const playersSnapshot = await getDocs(collection(db, "players"));
        const players = [];
        playersSnapshot.forEach(doc => players.push(doc.data().name));
        if(players.length === 0) return alert("No players to start a session!");

        const docRef = await addDoc(collection(db, "sessions"), {
          name: `Session ${new Date().toLocaleTimeString()}`,
          players: players,
          createdAt: new Date(),
          status: "waiting",
          buyIn: 0,
          moneyInHand: 0,
          holeCards: {},
          board: { flop: [], turn: "", river: "" }
        });
        console.log("‚úÖ Session created with ID:", docRef.id);
      } catch(e) {
        console.error("‚ùå Error creating session:", e);
      }
    });

    // üîπ Live session list
    onSnapshot(collection(db, "sessions"), snapshot => {
      sessionList.innerHTML = "";
      snapshot.forEach(doc => {
        const s = doc.data();
        const li = document.createElement("li");
        li.textContent = `${s.name} | Players: ${s.players.join(", ")} | Status: ${s.status}`;
        sessionList.appendChild(li);
      });
    });

    // üîπ Submit Hole Cards
    submitHoleBtn.addEventListener("click", async () => {
      const c1 = card1Input.value.trim();
      const c2 = card2Input.value.trim();
      if(!c1 || !c2) return alert("Enter both cards!");

      try {
        const sessionsSnapshot = await getDocs(collection(db, "sessions"));
        let latestSession = null;
        sessionsSnapshot.forEach(doc => latestSession = { id: doc.id, data: doc.data() }); 

        if(!latestSession) return alert("No session found!");

        const sessionRef = doc(db, "sessions", latestSession.id);
        const newHoleCards = latestSession.data.holeCards || {};
        newHoleCards[playerName] = [c1, c2];

        await updateDoc(sessionRef, { holeCards: newHoleCards });
        console.log("‚úÖ Hole cards submitted!");
        alert("Hole cards submitted!");
      } catch(e) {
        console.error("‚ùå Error submitting hole cards:", e);
      }
    });

    // üîπ Admin & Board: real-time updates via onSnapshot
    onSnapshot(collection(db, "sessions"), snapshot => {
      let latestSession = null;
      snapshot.forEach(doc => latestSession = { id: doc.id, data: doc.data() });
      if(!latestSession) return;

      const data = latestSession.data;

      // Update hole cards
      const holeCards = data.holeCards || {};
      allHoleCardsList.innerHTML = "";
      for(const [name, cards] of Object.entries(holeCards)) {
        const li = document.createElement("li");
        li.textContent = `${name}: ${cards.join(", ")}`;
        allHoleCardsList.appendChild(li);
      }

      // Update board inputs only if user is not actively typing
      if(document.activeElement !== flopInput) flopInput.value = data.board?.flop.join(", ") || "";
      if(document.activeElement !== turnInput) turnInput.value = data.board?.turn || "";
      if(document.activeElement !== riverInput) riverInput.value = data.board?.river || "";
    });

    // üîπ Submit board (flop/turn/river)
    submitBoardBtn.addEventListener("click", async () => {
      try {
        const sessionsSnapshot = await getDocs(collection(db, "sessions"));
        let latestSession = null;
        sessionsSnapshot.forEach(doc => latestSession = { id: doc.id, data: doc.data() });
        if(!latestSession) return alert("No session found!");

        const sessionRef = doc(db, "sessions", latestSession.id);
        await updateDoc(sessionRef, {
          board: {
            flop: flopInput.value.split(",").map(s => s.trim()).filter(s => s),
            turn: turnInput.value.trim(),
            river: riverInput.value.trim()
          }
        });

        alert("‚úÖ Board updated!");
        console.log("Board written to Firestore:", {
          flop: flopInput.value,
          turn: turnInput.value,
          river: riverInput.value
        });
      } catch(e) {
        console.error("‚ùå Error updating board:", e);
      }
    });

  </script>
</head>
<body>
  <h1>Jojo Poker Lobby</h1>
  <input id="nameInput" placeholder="Enter your name" />
  <button id="joinBtn">Join Lobby</button>

  <h2>Players in Lobby:</h2>
  <ul id="players"></ul>

  <button id="startBtn">Start Game</button>
  <button id="createSessionBtn">Create Poker Session</button>

  <h2>Active Sessions:</h2>
  <ul id="sessionList"></ul>

  <p id="gameStatus"></p>

  <div id="holeCardsDiv" style="display:block;">
    <h2>Your Hole Cards</h2>
    <input id="card1" placeholder="Card 1 (e.g., Ah)" />
    <input id="card2" placeholder="Card 2 (e.g., Kd)" />
    <button id="submitHoleBtn">Submit Hole Cards</button>
  </div>

  <div id="adminDiv">
    <h2>Admin / Dealer View</h2>
    <ul id="allHoleCardsList"></ul>

    <h3>Board Cards</h3>
    <input id="flopInput" placeholder="Flop cards (comma separated)" />
    <input id="turnInput" placeholder="Turn card" />
    <input id="riverInput" placeholder="River card" />
    <button id="submitBoardBtn">Update Board</button>
  </div>
</body>
</html>
