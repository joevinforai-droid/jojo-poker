<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jojo Poker</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, doc, setDoc, updateDoc, getDoc, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { evalHand } from "https://cdn.jsdelivr.net/npm/poker-evaluator@2.0.1/dist/poker-evaluator.min.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiurHUaSI9ytpiTLps9MqY4QHF4MbEt24",
      authDomain: "jojo-pokler.firebaseapp.com",
      projectId: "jojo-pokler",
      storageBucket: "jojo-pokler.firebasestorage.app",
      messagingSenderId: "963260398028",
      appId: "1:963260398028:web:ce28df14ea78042e968569"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elements
    const nameInput = document.getElementById("nameInput");
    const joinBtn = document.getElementById("joinBtn");
    const playersList = document.getElementById("players");
    const startBtn = document.getElementById("startBtn");
    const gameStatus = document.getElementById("gameStatus");
    const holeCardsDiv = document.getElementById("holeCardsDiv");
    const card1Input = document.getElementById("card1");
    const card2Input = document.getElementById("card2");
    const submitHoleBtn = document.getElementById("submitHoleBtn");

    const adminDiv = document.getElementById("adminDiv");
    const allHoleCardsList = document.getElementById("allHoleCardsList");
    const flopInputs = [
      document.getElementById("flop1Input"),
      document.getElementById("flop2Input"),
      document.getElementById("flop3Input")
    ];
    const turnInput = document.getElementById("turnInput");
    const riverInput = document.getElementById("riverInput");
    const submitBoardBtn = document.getElementById("submitBoardBtn");
    const resetBoardBtn = document.getElementById("resetBoardBtn");

    let playerName = "";
    const sessionDoc = doc(db, "sessions", "current"); // single session doc

    // Join Lobby
    joinBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      if (!name) return alert("Enter your name!");
      playerName = name;

      try {
        const sessionSnap = await getDoc(sessionDoc);
        let sessionData = {};
        if (sessionSnap.exists()) sessionData = sessionSnap.data();
        const players = sessionData.players || [];
        if (!players.includes(name)) players.push(name);

        await setDoc(sessionDoc, { 
          players, 
          status: sessionData.status || "waiting",
          holeCards: sessionData.holeCards || {},
          board: sessionData.board || { flop: ["", "", ""], turn: "", river: "" }
        });
        holeCardsDiv.style.display = "block";
        console.log("✅ Player joined:", name);
      } catch(e) {
        console.error("❌ Error joining:", e);
      }
    });

    // Live players list
    onSnapshot(sessionDoc, docSnap => {
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      playersList.innerHTML = "";
      (data.players || []).forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        playersList.appendChild(li);
      });
      gameStatus.innerText = `Game Status: ${data.status || "waiting"}`;

      // Hole cards admin view + win probability
      const holeCards = data.holeCards || {};
      allHoleCardsList.innerHTML = "";
      const boardCards = [...(data.board?.flop || []), data.board?.turn, data.board?.river].filter(Boolean);

      for (const [name, cards] of Object.entries(holeCards)) {
        const li = document.createElement("li");
        li.textContent = `${name}: ${cards.join(", ")}`;

        // Calculate win probability using simple Monte Carlo simulation (basic)
        // For now we just show evaluation of current hand vs board
        try {
          const combined = [...cards, ...boardCards];
          const evalResult = evalHand(combined.map(c => c.toUpperCase()));
          li.textContent += ` | Hand Rank: ${evalResult.name}`;
        } catch(e) {
          li.textContent += ` | Hand Rank: N/A`;
        }

        allHoleCardsList.appendChild(li);
      }

      // Board inputs only overwrite if different and not typing
      data.board?.flop?.forEach((card, i) => {
        if (flopInputs[i].value !== card && document.activeElement !== flopInputs[i]) {
          flopInputs[i].value = card;
        }
      });
      if (turnInput.value !== data.board?.turn && document.activeElement !== turnInput) {
        turnInput.value = data.board?.turn || "";
      }
      if (riverInput.value !== data.board?.river && document.activeElement !== riverInput) {
        riverInput.value = data.board?.river || "";
      }
    });

    // Start Game
    startBtn.addEventListener("click", async () => {
      try {
        const sessionSnap = await getDoc(sessionDoc);
        let sessionData = sessionSnap.exists() ? sessionSnap.data() : {};
        await setDoc(sessionDoc, { 
          ...sessionData, 
          status: "started" 
        });
        console.log("✅ Game started!");
      } catch(e) {
        console.error("❌ Error starting game:", e);
      }
    });

    // Submit Hole Cards
    submitHoleBtn.addEventListener("click", async () => {
      const c1 = card1Input.value.trim();
      const c2 = card2Input.value.trim();
      if (!c1 || !c2) return alert("Enter both cards!");
      try {
        const sessionSnap = await getDoc(sessionDoc);
        if (!sessionSnap.exists()) return alert("No session found!");
        const sessionData = sessionSnap.data();
        const newHoleCards = sessionData.holeCards || {};
        newHoleCards[playerName] = [c1, c2];
        await updateDoc(sessionDoc, { holeCards: newHoleCards });
        console.log("✅ Hole cards submitted!");
        alert("Hole cards submitted!");
      } catch(e) {
        console.error("❌ Error submitting hole cards:", e);
      }
    });

    // Submit Board
    submitBoardBtn.addEventListener("click", async () => {
      try {
        const sessionSnap = await getDoc(sessionDoc);
        if (!sessionSnap.exists()) return alert("No session found!");
        const sessionData = sessionSnap.data();
        const flopValues = flopInputs.map(input => input.value.trim());
        await updateDoc(sessionDoc, {
          board: {
            flop: flopValues,
            turn: turnInput.value.trim(),
            river: riverInput.value.trim()
          }
        });
        alert("✅ Board updated!");
      } catch(e) {
        console.error("❌ Error updating board:", e);
      }
    });

    // Reset Board
    resetBoardBtn.addEventListener("click", async () => {
      try {
        const sessionSnap = await getDoc(sessionDoc);
        if (!sessionSnap.exists()) return;
        await updateDoc(sessionDoc, {
          board: { flop: ["", "", ""], turn: "", river: "" }
        });
        alert("✅ Board reset!");
      } catch(e) {
        console.error("❌ Error resetting board:", e);
      }
    });

  </script>
</head>
<body>
  <h1>Jojo Poker Lobby</h1>
  <input id="nameInput" placeholder="Enter your name" />
  <button id="joinBtn">Join Lobby</button>

  <h2>Players in Lobby:</h2>
  <ul id="players"></ul>

  <button id="startBtn">Start Game</button>
  <p id="gameStatus"></p>

  <div id="holeCardsDiv" style="display:block;">
    <h2>Your Hole Cards</h2>
    <input id="card1" placeholder="Card 1 (e.g., Ah)" />
    <input id="card2" placeholder="Card 2 (e.g., Kd)" />
    <button id="submitHoleBtn">Submit Hole Cards</button>
  </div>

  <div id="adminDiv">
    <h2>Admin / Dealer View</h2>
    <ul id="allHoleCardsList"></ul>

    <h3>Board Cards</h3>
    <input id="flop1Input" placeholder="Flop Card 1" />
    <input id="flop2Input" placeholder="Flop Card 2" />
    <input id="flop3Input" placeholder="Flop Card 3" />
    <input id="turnInput" placeholder="Turn Card" />
    <input id="riverInput" placeholder="River Card" />
    <button id="submitBoardBtn">Update Board</button>
    <button id="resetBoardBtn">Reset Board</button>
  </div>
</body>
</html>
